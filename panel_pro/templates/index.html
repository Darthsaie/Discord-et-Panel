{% extends "base.html" %}
{% block content %}

<style>
  .guilds { margin:.5rem 0 1rem 0; }
  .guilds li { display:flex; align-items:center; gap:.5rem; margin:.25rem 0; flex-wrap:wrap; }
  .row { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin:.35rem 0; }
  .row form { margin:0; }
  .btn-sm { padding:.35rem .6rem; font-size:.85rem; }
  .grid { display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:1rem; }
  @media (max-width:1100px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
  @media (max-width:640px){ .grid{grid-template-columns:1fr;}}
</style>

<h2>Panel</h2>
<p>Choisis un serveur et active un bot en essai 15 jours. Les bots non actifs apparaissent grisés.</p>

<h4>Mes serveurs (guilds)</h4>
<ul class="guilds">
  {% for g in guilds %}
    {% set gid = g.id if g.id is defined else g['id'] %}
    {% set name = g.name if g.name is defined else g['name'] %}
    <li>
      <span class="badge">{{ name }}</span> — ID: {{ gid }}
      <form method="post" action="{{ url_for('guild_delete', guild_id=gid) }}" onsubmit="return confirm('Supprimer {{ name }} du panel ?');">
        <button type="submit" class="secondary btn-sm">Supprimer</button>
      </form>
    </li>
  {% endfor %}
</ul>

<div class="grid">
{% for bot in bots %}
  <article class="card">
    <header>
      <strong>{{ bot.name }}</strong>
      <span class="tag">{{ bot.key }}</span>
    </header>
    <div>
      <p>États par serveur:</p>

      {% for g in guilds %}
        {% set gid = g.id if g.id is defined else g['id'] %}
        {% set name = g.name if g.name is defined else g['name'] %}
        {% set subs = submap.get((gid, bot.key), []) %}

        <div class="row">
          <span>• <span class="badge">{{ name }}</span></span>

          {% if subs and subs[0].status == 'active' %}
            <span class="tag">Actif</span>
            <a href="{{ url_for('invite', guild_id=gid, bot_key=bot.key) }}" role="button" class="secondary btn-sm">Inviter le bot</a>
            <form method="post" action="{{ url_for('cancel', guild_id=gid, bot_key=bot.key) }}">
              <button type="submit" class="secondary btn-sm">Annuler</button>
            </form>

          {% elif subs and subs[0].status == 'trial' and subs[0].trial_until %}
            <span class="tag">Essai jusqu’au {{ subs[0].trial_until.strftime('%d/%m/%Y') }}</span>
            <a href="{{ url_for('invite', guild_id=gid, bot_key=bot.key) }}" role="button" class="secondary btn-sm">Inviter le bot</a>
            <form method="post" action="{{ url_for('cancel', guild_id=gid, bot_key=bot.key) }}">
              <button type="submit" class="secondary btn-sm">Annuler l’essai</button>
            </form>

          {% else %}
            <form method="post" action="{{ url_for('activate', guild_id=gid, bot_key=bot.key) }}">
              <button type="submit" class="btn-sm">Activer l'essai</button>
            </form>
            <a href="{{ url_for('invite', guild_id=gid, bot_key=bot.key) }}" role="button" class="secondary btn-sm">Inviter le bot</a>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </article>
{% endfor %}
</div>

{% endblock %}
