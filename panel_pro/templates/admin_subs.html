{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root {
    --bg-primary: #0a0e1a;
    --bg-secondary: #111827;
    --bg-card: rgba(17, 24, 39, 0.6);
    --border-color: rgba(255, 255, 255, 0.06);
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --accent: #6366f1;
    --accent-glow: rgba(99, 102, 241, 0.3);
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }

  * { box-sizing: border-box; }
  
  body {
    background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 50%, #0f1729 100%);
    min-height: 100vh;
  }

  /* === BACKGROUND EFFECTS === */
  .admin-container {
    max-width: 1600px;
    margin: 0 auto;
    position: relative;
  }
  
  .admin-container::before {
    content: '';
    position: fixed;
    top: -50%;
    right: -20%;
    width: 800px;
    height: 800px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: float 20s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(-50px, 50px) scale(1.1); }
  }

  /* === GLASSMORPHISM === */
  .glass-card {
    background: rgba(17, 24, 39, 0.4);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .glass-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
    transition: 0.5s;
  }
  
  .glass-card:hover::before {
    left: 100%;
  }

  /* === HEADER === */
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    flex-wrap: wrap;
    gap: 20px;
    position: relative;
    z-index: 1;
  }
  
  .admin-title {
    font-size: 3rem;
    font-weight: 900;
    margin: 0;
    background: linear-gradient(135deg, #fff 0%, #818cf8 50%, #6366f1 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -1px;
    text-shadow: 0 0 80px rgba(99, 102, 241, 0.5);
  }
  
  .admin-subtitle {
    margin: 8px 0 0 0;
    color: var(--text-secondary);
    font-size: 1rem;
    font-weight: 500;
  }

  /* === KPI CARDS === */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
    position: relative;
    z-index: 1;
  }
  
  .kpi-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.5) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }
  
  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s ease;
  }
  
  .kpi-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 40px var(--glow);
    border-color: rgba(255, 255, 255, 0.2);
  }
  
  .kpi-card:hover::before {
    transform: scaleX(1);
  }
  
  .kpi-total { --gradient: linear-gradient(90deg, #a78bfa, #8b5cf6); --glow: rgba(139, 92, 246, 0.3); }
  .kpi-active { --gradient: linear-gradient(90deg, #34d399, #10b981); --glow: rgba(16, 185, 129, 0.3); }
  .kpi-trial { --gradient: linear-gradient(90deg, #fb923c, #f97316); --glow: rgba(249, 115, 22, 0.3); }
  .kpi-cancel { --gradient: linear-gradient(90deg, #f87171, #ef4444); --glow: rgba(239, 68, 68, 0.3); }
  
  .kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }
  
  .kpi-icon {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: var(--icon-bg);
    color: var(--icon-color);
    box-shadow: 0 4px 16px var(--icon-shadow);
  }
  
  .kpi-total .kpi-icon { --icon-bg: rgba(139, 92, 246, 0.15); --icon-color: #a78bfa; --icon-shadow: rgba(139, 92, 246, 0.3); }
  .kpi-active .kpi-icon { --icon-bg: rgba(16, 185, 129, 0.15); --icon-color: #34d399; --icon-shadow: rgba(16, 185, 129, 0.3); }
  .kpi-trial .kpi-icon { --icon-bg: rgba(249, 115, 22, 0.15); --icon-color: #fb923c; --icon-shadow: rgba(249, 115, 22, 0.3); }
  .kpi-cancel .kpi-icon { --icon-bg: rgba(239, 68, 68, 0.15); --icon-color: #f87171; --icon-shadow: rgba(239, 68, 68, 0.3); }
  
  .kpi-trend {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  
  .trend-up { background: rgba(16, 185, 129, 0.15); color: #34d399; }
  .trend-down { background: rgba(239, 68, 68, 0.15); color: #f87171; }
  
  .kpi-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-secondary);
    font-weight: 700;
    margin-bottom: 8px;
  }
  
  .kpi-value {
    font-size: 2.8rem;
    font-weight: 900;
    color: var(--text-primary);
    line-height: 1;
    letter-spacing: -2px;
  }

  /* === BUTTONS === */
  .btn-modern {
    position: relative;
    padding: 12px 24px;
    border-radius: 14px;
    border: none;
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
  }
  
  .btn-modern::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }
  
  .btn-modern:hover::before {
    width: 300px;
    height: 300px;
  }
  
  .btn-modern span {
    position: relative;
    z-index: 1;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
  }
  
  .btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 28px rgba(99, 102, 241, 0.6);
  }
  
  .icon-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 1.1rem;
  }
  
  .icon-btn:hover {
    background: white;
    color: #0a0e1a;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 16px rgba(255, 255, 255, 0.2);
  }
  
  .icon-btn.active {
    background: var(--success);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }

  /* === TOOLBAR === */
  .toolbar {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  
  .toolbar-section {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .filter-pills {
    background: rgba(0, 0, 0, 0.3);
    padding: 6px;
    border-radius: 14px;
    display: flex;
    gap: 6px;
    border: 1px solid rgba(255, 255, 255, 0.06);
  }
  
  .filter-pill {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    padding: 9px 18px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    position: relative;
  }
  
  .filter-pill::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-glow));
    opacity: 0;
    transition: opacity 0.3s;
  }
  
  .filter-pill:hover {
    color: white;
  }
  
  .filter-pill.active {
    color: white;
    position: relative;
  }
  
  .filter-pill.active::before {
    opacity: 1;
  }
  
  .filter-pill span {
    position: relative;
    z-index: 1;
  }
  
  .search-wrapper {
    position: relative;
    flex: 1;
    max-width: 400px;
  }
  
  .search-input {
    width: 100%;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    padding: 12px 16px 12px 44px;
    border-radius: 14px;
    font-family: inherit;
    font-size: 0.9rem;
    transition: all 0.3s;
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--accent);
    background: rgba(0, 0, 0, 0.5);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 8px 24px rgba(0, 0, 0, 0.3);
  }
  
  .search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1.1rem;
    pointer-events: none;
  }

  /* === TABLE === */
  .table-container {
    position: relative;
    z-index: 1;
  }
  
  .table-wrapper {
    border-radius: 20px;
    overflow: hidden;
    background: rgba(17, 24, 39, 0.4);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }
  
  .table-scroll {
    max-height: 650px;
    overflow-y: auto;
    overflow-x: auto;
  }
  
  .table-scroll::-webkit-scrollbar { width: 10px; height: 10px; }
  .table-scroll::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
  .table-scroll::-webkit-scrollbar-thumb { 
    background: rgba(99, 102, 241, 0.3);
    border-radius: 10px;
  }
  .table-scroll::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }
  
  .data-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
  }
  
  .data-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(180deg, #1a2332 0%, #111827 100%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .data-table th {
    text-align: left;
    padding: 18px 16px;
    color: var(--text-secondary);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 800;
    border-bottom: 2px solid rgba(99, 102, 241, 0.2);
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
  }
  
  .data-table th:hover {
    color: white;
    background: rgba(255, 255, 255, 0.03);
  }
  
  .data-table th.sortable::after {
    content: '⇅';
    margin-left: 6px;
    opacity: 0.2;
    font-size: 0.9rem;
  }
  
  .data-table th.sort-asc::after { content: '▲'; opacity: 1; color: var(--accent); }
  .data-table th.sort-desc::after { content: '▼'; opacity: 1; color: var(--accent); }
  
  .data-table tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .data-table tbody tr:hover {
    background: rgba(99, 102, 241, 0.08);
    transform: scale(1.005);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  
  .data-table tbody tr.selected {
    background: rgba(99, 102, 241, 0.15);
    border-left: 3px solid var(--accent);
  }
  
  .data-table td {
    padding: 16px;
    vertical-align: middle;
  }

  /* === AVATAR === */
  .bot-avatar {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, #1e293b, #0f172a);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
  }
  
  .bot-avatar:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  }
  
  .bot-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* === STATUS BADGES === */
  .status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid;
    transition: all 0.3s;
  }
  
  .status-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.9); }
  }
  
  .status-badge:hover {
    transform: scale(1.05);
  }
  
  .st-active { background: rgba(16, 185, 129, 0.15); color: #34d399; border-color: rgba(16, 185, 129, 0.3); }
  .st-trialing, .st-trial { background: rgba(249, 115, 22, 0.15); color: #fb923c; border-color: rgba(249, 115, 22, 0.3); }
  .st-canceled { background: rgba(239, 68, 68, 0.15); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
  .st-unpaid { background: rgba(239, 68, 68, 0.15); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
  .st-incomplete { background: rgba(148, 163, 184, 0.15); color: #94a3b8; border-color: rgba(148, 163, 184, 0.3); }
  .st-past_due { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); }
  .st-lifetime { 
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.2));
    color: #c4b5fd;
    border-color: rgba(139, 92, 246, 0.4);
  }

  /* === DAYS LEFT === */
  .days-badge {
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 10px;
    display: inline-block;
    font-size: 0.85rem;
    border: 1px solid;
    transition: all 0.3s;
  }
  
  .days-badge:hover {
    transform: scale(1.05);
  }
  
  .days-critical {
    background: rgba(239, 68, 68, 0.15);
    color: #f87171;
    border-color: rgba(239, 68, 68, 0.3);
  }
  
  .days-warning {
    background: rgba(251, 146, 60, 0.15);
    color: #fb923c;
    border-color: rgba(251, 146, 60, 0.3);
  }
  
  .days-good {
    background: rgba(16, 185, 129, 0.15);
    color: #34d399;
    border-color: rgba(16, 185, 129, 0.3);
  }

  /* === ACTION BUTTONS === */
  .actions-group {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .action-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-secondary);
    font-size: 1rem;
  }
  
  .action-btn:hover {
    transform: translateY(-3px) scale(1.1);
  }
  
  .action-btn.btn-sync:hover {
    background: #3b82f6;
    color: white;
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
  }
  
  .action-btn.btn-edit:hover {
    background: #8b5cf6;
    color: white;
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
  }
  
  .action-btn.btn-delete:hover {
    background: #ef4444;
    color: white;
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
  }

  /* === BULK ACTIONS BAR === */
  .bulk-bar {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 16px;
    padding: 16px 24px;
    margin-bottom: 20px;
    display: none;
    align-items: center;
    gap: 20px;
    animation: slideDown 0.3s ease;
  }
  
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .bulk-bar.show { display: flex; }
  
  .bulk-text {
    flex: 1;
    font-weight: 700;
    color: #a5b4fc;
    font-size: 0.95rem;
  }
  
  .bulk-btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .bulk-btn-export {
    background: var(--success);
    color: white;
  }
  
  .bulk-btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
  }
  
  .bulk-btn-clear {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }
  
  .bulk-btn-clear:hover {
    background: var(--danger);
  }

  /* === CHARTS === */
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 40px;
    position: relative;
    z-index: 1;
  }
  
  .chart-card {
    background: rgba(17, 24, 39, 0.4);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    padding: 24px;
    height: 300px;
    transition: all 0.3s;
  }
  
  .chart-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
  }

  /* === MODALS === */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(12px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .modal-content {
    background: linear-gradient(135deg, #1a2332 0%, #111827 100%);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 24px;
    padding: 32px;
    width: 90%;
    max-width: 540px;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .modal-content.modal-large {
    max-width: 900px;
  }
  
  @keyframes slideUp {
    from { transform: translateY(40px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
  }
  
  .modal-title {
    font-size: 1.8rem;
    font-weight: 900;
    margin: 0;
    background: linear-gradient(135deg, #fff, #a5b4fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .modal-close {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: none;
    background: rgba(255, 255, 255, 0.08);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal-close:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: rotate(90deg);
  }
  
  .input-group {
    margin-bottom: 20px;
  }
  
  .input-label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-secondary);
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .modal-input {
    width: 100%;
    padding: 14px 16px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    font-family: inherit;
    font-size: 1rem;
    transition: all 0.3s;
  }
  
  .modal-input:focus {
    outline: none;
    border-color: var(--accent);
    background: rgba(0, 0, 0, 0.6);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  }
  
  .modal-input option {
    background: #1a2332;
    color: white;
  }
  
  .form-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    padding: 20px;
    border-radius: 14px;
    margin-bottom: 16px;
  }

  /* === PAGINATION === */
  .pagination {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 28px;
    flex-wrap: wrap;
  }
  
  .page-link {
    padding: 10px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: var(--text-secondary);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s;
    text-decoration: none;
  }
  
  .page-link:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: translateY(-2px);
  }
  
  .page-link.active {
    background: linear-gradient(135deg, var(--accent), #8b5cf6);
    color: white;
    box-shadow: 0 4px 12px var(--accent-glow);
  }

  /* === LOADING === */
  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* === EMPTY STATE === */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-secondary);
  }
  
  .empty-state i {
    font-size: 5rem;
    opacity: 0.2;
    margin-bottom: 24px;
  }

  /* === RESPONSIVE === */
  @media (max-width: 1200px) {
    .charts-grid { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  }
  
  @media (max-width: 768px) {
    .admin-title { font-size: 2rem; }
    .kpi-grid { grid-template-columns: 1fr; }
    .toolbar { flex-direction: column; }
    .search-wrapper { max-width: 100%; }
  }

  /* === LOCKS COMPACT BADGE === */
  .locks-badge {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    padding: 8px 16px;
    border-radius: 12px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
    font-size: 0.85rem;
  }
  
  .locks-badge:hover {
    background: rgba(239, 68, 68, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }
  
  .locks-badge-icon {
    width: 24px;
    height: 24px;
    background: rgba(239, 68, 68, 0.3);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f87171;
  }
  
  .locks-badge-count {
    color: #f87171;
    font-weight: 800;
    font-size: 1rem;
  }
  
  .locks-badge-text {
    color: #e2e8f0;
  }

  /* === LOCKS TABLE IN MODAL === */
  .locks-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .locks-table thead {
    background: rgba(0, 0, 0, 0.3);
  }
  
  .locks-table th {
    text-align: left;
    padding: 12px;
    color: var(--text-secondary);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .locks-table tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: 0.2s;
  }
  
  .locks-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .locks-table td {
    padding: 12px;
    font-size: 0.85rem;
  }

  /* === CHECKBOX === */
  .custom-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--accent);
  }
</style>

<div class="admin-container">

  <!-- HEADER -->
  <div class="admin-header">
    <div>
      <h1 class="admin-title">Administration</h1>
      <p class="admin-subtitle">Gestion professionnelle des abonnements</p>
    </div>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      {% if locks %}
      <div class="locks-badge" onclick="openLocksModal()">
        <div class="locks-badge-icon">
          <i class="ph ph-lock-key"></i>
        </div>
        <span class="locks-badge-count">{{ locks|length }}</span>
        <span class="locks-badge-text">Locks</span>
      </div>
      {% endif %}
      <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="icon-btn" title="Auto-refresh">
        <i class="ph ph-arrow-clockwise"></i>
      </button>
      <button onclick="exportCSV()" class="icon-btn" title="Export CSV">
        <i class="ph ph-download-simple"></i>
      </button>
      <button onclick="openAddModal()" class="btn-modern btn-primary">
        <span><i class="ph ph-plus-circle"></i> Nouvel Accès</span>
      </button>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="kpi-grid">
    <div class="kpi-card kpi-total">
      <div class="kpi-header">
        <div class="kpi-icon">
          <i class="ph ph-database"></i>
        </div>
        <div class="kpi-trend trend-up">+8%</div>
      </div>
      <div class="kpi-label">Total Serveurs</div>
      <div class="kpi-value">{{ stats.total }}</div>
    </div>
    
    <div class="kpi-card kpi-active">
      <div class="kpi-header">
        <div class="kpi-icon">
          <i class="ph ph-check-circle"></i>
        </div>
        <div class="kpi-trend trend-up">+12%</div>
      </div>
      <div class="kpi-label">Abonnements Actifs</div>
      <div class="kpi-value" style="color:#34d399;">{{ stats.active }}</div>
    </div>
    
    <div class="kpi-card kpi-trial">
      <div class="kpi-header">
        <div class="kpi-icon">
          <i class="ph ph-clock"></i>
        </div>
        <div class="kpi-trend trend-up">+5%</div>
      </div>
      <div class="kpi-label">En Essai</div>
      <div class="kpi-value" style="color:#fb923c;">{{ stats.trial }}</div>
    </div>
    
    <div class="kpi-card kpi-cancel">
      <div class="kpi-header">
        <div class="kpi-icon">
          <i class="ph ph-x-circle"></i>
        </div>
        <div class="kpi-trend trend-down">-3%</div>
      </div>
      <div class="kpi-label">Inactifs</div>
      <div class="kpi-value" style="color:#f87171;">{{ stats.canceled }}</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <div class="chart-card">
      <canvas id="chartBot"></canvas>
    </div>
    <div class="chart-card">
      <canvas id="chartStatus"></canvas>
    </div>
  </div>

  <!-- TABLE -->
  <div class="glass-card" style="padding:0; overflow:hidden;">
    
    <!-- TOOLBAR -->
    <div style="padding:24px 24px 20px 24px;">
      <div class="toolbar">
        <div class="toolbar-section">
          <div class="filter-pills">
            <button class="filter-pill active" onclick="filterTable('all')">
              <span>Tout</span>
            </button>
            <button class="filter-pill" onclick="filterTable('active')">
              <span>Actifs</span>
            </button>
            <button class="filter-pill" onclick="filterTable('trial')">
              <span>Essais</span>
            </button>
            <button class="filter-pill" onclick="filterTable('canceled')">
              <span>Inactifs</span>
            </button>
            <button class="filter-pill" onclick="filterTable('lifetime')">
              <span>VIP</span>
            </button>
          </div>
          
          <div class="search-wrapper">
            <i class="ph ph-magnifying-glass search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Rechercher..." onkeyup="debounceSearch()">
          </div>
        </div>
        
        <div class="toolbar-section">
          <button class="icon-btn" onclick="refreshTable()" title="Rafraîchir">
            <i class="ph ph-arrows-clockwise"></i>
          </button>
        </div>
      </div>

      <!-- BULK ACTIONS -->
      <div class="bulk-bar" id="bulkBar">
        <span class="bulk-text">
          <i class="ph ph-check-square"></i>
          <span id="selectedCount">0</span> sélectionné(s)
        </span>
        <button class="bulk-btn bulk-btn-export" onclick="exportSelected()">
          <i class="ph ph-download-simple"></i> Exporter
        </button>
        <button class="bulk-btn bulk-btn-clear" onclick="clearSelection()">
          <i class="ph ph-x"></i> Annuler
        </button>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-wrapper">
      <div class="table-scroll">
        <table class="data-table" id="dataTable">
          <thead>
            <tr>
              <th style="width:50px;">
                <input type="checkbox" class="custom-checkbox" id="selectAll" onchange="toggleSelectAll()">
              </th>
              <th class="sortable" onclick="sortTable('bot')">Bot</th>
              <th class="sortable" onclick="sortTable('guild')">Serveur</th>
              <th class="sortable" onclick="sortTable('status')">Statut</th>
              <th class="sortable" onclick="sortTable('days')">Jours Rest.</th>
              <th class="sortable" onclick="sortTable('expiry')">Expiration</th>
              <th style="text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for s in subs %}
            <tr data-status="{{ s.status }}" 
                data-bot="{{ s.bot_type.key }}"
                data-guild="{{ s.guild.name|lower }}"
                data-days="{{ s.days_left if s.days_left else 999999 }}"
                data-expiry="{{ s.current_period_end.timestamp() if s.current_period_end else (s.trial_until.timestamp() if s.trial_until else 0) }}"
                data-search="{{ s.guild.name|lower }} {{ s.bot_type.key|lower }} {{ s.guild.discord_id }}">
              
              <td>
                <input type="checkbox" class="custom-checkbox row-select" data-id="{{ s.id }}" onchange="updateBulkActions()">
              </td>

              <td>
                <div style="display:flex; align-items:center; gap:14px;">
                  <div class="bot-avatar">
                    {% if bot_avatars.get(s.bot_type.key) %}
                    <img src="{{ bot_avatars[s.bot_type.key] }}" alt="{{ s.bot_type.key }}">
                    {% else %}
                    <span style="color:#fff; font-weight:900; font-size:1rem;">{{ s.bot_type.key[0]|upper }}</span>
                    {% endif %}
                  </div>
                  <div>
                    <div style="font-weight:700; color:#f8fafc; text-transform:capitalize; font-size:0.95rem;">
                      {{ s.bot_type.key }}
                    </div>
                    <div style="font-family:monospace; font-size:0.7rem; color:var(--text-secondary); opacity:0.5;">
                      #{{ s.id }}
                    </div>
                  </div>
                </div>
              </td>

              <td>
                <div>
                  <div style="font-weight:600; color:#e2e8f0; font-size:0.9rem;">{{ s.guild.name }}</div>
                  <div style="font-family:monospace; font-size:0.75rem; color:var(--text-secondary); opacity:0.4; margin-top:2px;">
                    {{ s.guild.discord_id }}
                  </div>
                </div>
              </td>

              <td>
                <span class="status-badge st-{{ s.status }}">
                  {% if s.status == 'active' %}Actif
                  {% elif s.status in ['trialing', 'trial'] %}Essai
                  {% elif s.status == 'lifetime' %}VIP
                  {% elif s.status == 'past_due' %}Retard
                  {% elif s.status == 'unpaid' %}Impayé
                  {% elif s.status == 'incomplete' %}Incomplet
                  {% else %}Terminé{% endif %}
                </span>
              </td>

              <td>
                {% if s.days_left is not none %}
                  {% if s.days_left >= 0 %}
                    <span class="days-badge {% if s.days_left < 7 %}days-critical{% elif s.days_left < 14 %}days-warning{% else %}days-good{% endif %}">
                      {{ s.days_left }} j
                    </span>
                  {% else %}
                    <span class="days-badge days-critical">Expiré</span>
                  {% endif %}
                {% elif s.status == 'lifetime' %}
                  <span style="color:#c4b5fd; font-weight:900; font-size:1.4rem;">∞</span>
                {% else %}
                  <span style="opacity:0.2;">-</span>
                {% endif %}
              </td>

              <td style="font-size:0.85rem;">
                {% if s.current_period_end %}
                  <div style="color:#34d399; font-weight:600; display:flex; align-items:center; gap:6px;">
                    <i class="ph ph-check-circle"></i> {{ s.current_period_end.strftime('%d/%m/%Y') }}
                  </div>
                {% elif s.trial_until %}
                  <div style="color:#fb923c; font-weight:600; display:flex; align-items:center; gap:6px;">
                    <i class="ph ph-clock"></i> {{ s.trial_until.strftime('%d/%m/%Y') }}
                  </div>
                {% elif s.status == 'lifetime' %}
                  <span style="color:#c4b5fd; font-weight:600;">♾️ Illimité</span>
                {% else %}
                  <span style="opacity:0.2;">-</span>
                {% endif %}
              </td>

              <td>
                <div class="actions-group">
                  <button class="action-btn btn-sync" title="Sync Stripe" onclick="syncStripe({{ s.id }})">
                    <i class="ph ph-arrows-clockwise"></i>
                  </button>
                  <button class="action-btn btn-edit" title="Modifier" onclick="openEditModal({{ s.id }}, '{{ s.guild.name|escape }}', '{{ s.bot_type.key }}', '{{ s.status }}')">
                    <i class="ph ph-gear"></i>
                  </button>
                  <button class="action-btn btn-delete" title="Supprimer" onclick="deleteSub({{ s.id }})">
                    <i class="ph ph-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="7">
                <div class="empty-state">
                  <i class="ph ph-folder-notch-open"></i>
                  <p style="font-size:1.2rem; font-weight:700; margin:10px 0; color:#e2e8f0;">Aucun abonnement</p>
                  <p style="font-size:0.9rem; opacity:0.5;">Créez votre premier accès</p>
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- PAGINATION -->
    {% if pages > 1 %}
    <div style="padding:20px 24px;">
      <div class="pagination">
        {% if page > 1 %}
          <a href="?page=1" class="page-link">««</a>
          <a href="?page={{ page - 1 }}" class="page-link">‹</a>
        {% endif %}
        
        {% for p in range(1, pages + 1) %}
          {% if p == 1 or p == pages or (p >= page - 2 and p <= page + 2) %}
            <a href="?page={{ p }}" class="page-link {% if p == page %}active{% endif %}">{{ p }}</a>
          {% elif p == page - 3 or p == page + 3 %}
            <span class="page-link" style="cursor:default; background:transparent; border:none;">...</span>
          {% endif %}
        {% endfor %}
        
        {% if page < pages %}
          <a href="?page={{ page + 1 }}" class="page-link">›</a>
          <a href="?page={{ pages }}" class="page-link">»»</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

</div>

<!-- MODAL ADD -->
<div id="modalAdd" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Nouvel Accès</h2>
      <button class="modal-close" onclick="closeModal('modalAdd')">&times;</button>
    </div>
    
    <form method="post" action="{{ url_for('admin_create_sub') }}">
      <div class="input-group">
        <label class="input-label">ID Discord Serveur</label>
        <input type="text" name="guild_discord_id" class="modal-input" placeholder="119613858..." required>
      </div>
      
      <div class="input-group">
        <label class="input-label">Nom du Serveur</label>
        <input type="text" name="guild_name" class="modal-input" placeholder="Mon Serveur Gaming">
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
        <div>
          <label class="input-label">Bot</label>
          <select name="bot_key" class="modal-input">
            {% for k,v in bot_defs.items() %}
            <option value="{{ k }}">{{ v.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="input-label">Statut</label>
          <select name="status" id="statusSelect" class="modal-input" onchange="updateDurationField()">
            <option value="trial">Essai</option>
            <option value="active">Actif</option>
            <option value="lifetime">VIP</option>
          </select>
        </div>
      </div>
      
      <div class="input-group" id="durationGroup">
        <label class="input-label">
          <span id="durationLabel">Durée de l'Essai (Jours)</span>
        </label>
        <input type="number" name="days" id="daysInput" value="5" class="modal-input" min="1">
        <small id="durationHint" style="color:#64748b; display:block; margin-top:8px; font-size:0.8rem;">
          <i class="ph ph-info"></i> L'essai durera <span id="daysPreview">5</span> jours
        </small>
      </div>
      
      <button type="submit" class="btn-modern btn-primary" style="width:100%; justify-content:center; margin-top:8px;">
        <span><i class="ph ph-check-circle"></i> Créer l'Accès</span>
      </button>
    </form>
  </div>
</div>

<!-- MODAL EDIT -->
<div id="modalEdit" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <h2 class="modal-title">Modifier</h2>
        <p id="editSubtitle" style="color:var(--text-secondary); margin:8px 0 0 0; font-size:0.9rem; font-weight:600;"></p>
      </div>
      <button class="modal-close" onclick="closeModal('modalEdit')">&times;</button>
    </div>

    <form id="formStatus" method="post" action="" class="form-section">
      <label class="input-label"><i class="ph ph-tag"></i> Changer le Statut</label>
      <div style="display:flex; gap:12px;">
        <select name="status" class="modal-input" style="flex:1;">
          <option value="active">Actif</option>
          <option value="trial">Essai</option>
          <option value="canceled">Annulé</option>
          <option value="lifetime">VIP</option>
        </select>
        <button type="submit" class="btn-modern btn-primary" style="padding:0 24px;">
          <span><i class="ph ph-check"></i></span>
        </button>
      </div>
    </form>

    <form id="formLinkStripe" method="post" action="" class="form-section" style="background:rgba(99, 102, 241, 0.08); border-color:rgba(99, 102, 241, 0.2);">
      <label class="input-label" style="color:#a5b4fc;"><i class="ph ph-link"></i> Lier Stripe</label>
      <div style="display:flex; gap:12px;">
        <input type="text" name="stripe_id" placeholder="sub_..." class="modal-input" style="flex:1;">
        <button type="submit" class="btn-modern btn-primary" style="padding:0 24px;">
          <span><i class="ph ph-plugs"></i></span>
        </button>
      </div>
      <small style="color:#94a3b8; font-size:0.75rem; margin-top:8px; display:block;">
        ID Stripe pour forcer la synchronisation
      </small>
    </form>
  </div>
</div>

<!-- MODAL LOCKS -->
<div id="modalLocks" class="modal-overlay">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <div>
        <h2 class="modal-title">Essais Consommés</h2>
        <p style="color:var(--text-secondary); margin:8px 0 0 0; font-size:0.9rem; font-weight:600;">
          {{ locks|length }} lock(s) actif(s)
        </p>
      </div>
      <button class="modal-close" onclick="closeModal('modalLocks')">&times;</button>
    </div>

    <div class="input-group">
      <div class="search-wrapper" style="max-width:100%;">
        <i class="ph ph-magnifying-glass search-icon"></i>
        <input type="text" id="searchLocks" class="search-input" placeholder="Rechercher un serveur, bot..." onkeyup="filterLocks()">
      </div>
    </div>

    <div style="max-height:500px; overflow-y:auto; border-radius:12px; background:rgba(0,0,0,0.2);">
      <table class="locks-table">
        <thead>
          <tr>
            <th>Serveur</th>
            <th>Bot</th>
            <th>User ID</th>
            <th>Expire</th>
            <th style="text-align:right;">Action</th>
          </tr>
        </thead>
        <tbody id="locksTableBody">
          {% for l in locks %}
          <tr data-search="{{ guild_map.get(l.guild_discord_id, l.guild_discord_id)|lower }} {{ l.bot_key|lower }} {{ l.discord_user_id }}">
            <td>
              <div style="font-weight:600; color:#e2e8f0;">
                {{ guild_map.get(l.guild_discord_id, l.guild_discord_id) }}
              </div>
              <div style="font-size:0.75rem; color:var(--text-secondary); opacity:0.5; font-family:monospace;">
                {{ l.guild_discord_id }}
              </div>
            </td>
            <td>
              <span style="padding:4px 10px; background:rgba(99, 102, 241, 0.15); color:#a5b4fc; border-radius:8px; font-weight:700; font-size:0.8rem; text-transform:uppercase;">
                {{ l.bot_key }}
              </span>
            </td>
            <td>
              <span style="font-family:monospace; color:var(--text-secondary); font-size:0.85rem;">
                {{ l.discord_user_id }}
              </span>
            </td>
            <td>
              <span style="color:#fb923c; font-weight:600; font-size:0.85rem;">
                {{ l.until.strftime('%d/%m/%Y %H:%M') }}
              </span>
            </td>
            <td style="text-align:right;">
              <button class="action-btn btn-delete" onclick="releaseLock({{ l.id }})" title="Libérer">
                <i class="ph ph-trash"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top:20px; padding:16px; background:rgba(239, 68, 68, 0.1); border:1px solid rgba(239, 68, 68, 0.2); border-radius:12px;">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
        <i class="ph ph-warning" style="font-size:1.5rem; color:#f87171;"></i>
        <div>
          <div style="font-weight:700; color:#f87171; font-size:0.9rem;">Zone Dangereuse</div>
          <div style="font-size:0.75rem; color:var(--text-secondary);">Action irréversible</div>
        </div>
      </div>
      <button class="btn-modern" style="background:#ef4444; color:white; width:100%; justify-content:center;" onclick="clearAllLocks()">
        <span><i class="ph ph-trash"></i> Supprimer TOUS les Locks</span>
      </button>
    </div>
  </div>
</div>

<script>
let currentFilter = 'all';
let currentSort = { column: null, direction: 'asc' };
let searchTimeout;
let autoRefreshInterval;
let isAutoRefresh = false;

// Charts Data
const botData = {};
const statusData = { active: {{ stats.active }}, trial: {{ stats.trial }}, canceled: {{ stats.canceled }} };

{% for s in subs %}
botData['{{ s.bot_type.key }}'] = (botData['{{ s.bot_type.key }}'] || 0) + 1;
{% endfor %}

// Chart Bot
const ctxBot = document.getElementById('chartBot').getContext('2d');
new Chart(ctxBot, {
  type: 'doughnut',
  data: {
    labels: Object.keys(botData).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
    datasets: [{
      data: Object.values(botData),
      backgroundColor: ['#a78bfa', '#34d399', '#fb923c', '#f87171'],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: true, position: 'bottom', labels: { color: '#94a3b8', font: { size: 11, weight: '600' } } },
      title: { display: true, text: 'Répartition par Bot', color: '#e2e8f0', font: { size: 14, weight: '700' } }
    }
  }
});

// Chart Status
const ctxStatus = document.getElementById('chartStatus').getContext('2d');
new Chart(ctxStatus, {
  type: 'bar',
  data: {
    labels: ['Actifs', 'Essais', 'Inactifs'],
    datasets: [{
      data: [statusData.active, statusData.trial, statusData.canceled],
      backgroundColor: ['#34d399', '#fb923c', '#f87171'],
      borderRadius: 8
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      title: { display: true, text: 'Statuts', color: '#e2e8f0', font: { size: 14, weight: '700' } }
    },
    scales: {
      y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
      x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
    }
  }
});

// === UPDATE DURATION FIELD BASED ON STATUS ===
function updateDurationField() {
  const status = document.getElementById('statusSelect').value;
  const durationGroup = document.getElementById('durationGroup');
  const durationLabel = document.getElementById('durationLabel');
  const durationHint = document.getElementById('durationHint');
  const daysInput = document.getElementById('daysInput');
  const daysPreview = document.getElementById('daysPreview');
  
  // Mise à jour en temps réel de la preview
  daysInput.oninput = function() {
    const preview = document.getElementById('daysPreview');
    if (preview) preview.textContent = this.value || '0';
  };
  
  switch(status) {
    case 'trial':
      durationGroup.style.display = 'block';
      durationLabel.innerHTML = 'Durée de l\'Essai (Jours)';
      durationHint.innerHTML = '<i class="ph ph-info"></i> L\'essai durera <span id="daysPreview">' + daysInput.value + '</span> jours';
      daysInput.value = daysInput.value || '5';
      daysInput.required = true;
      daysInput.min = '1';
      break;
      
    case 'active':
      durationGroup.style.display = 'block';
      durationLabel.innerHTML = 'Durée de l\'Abonnement (Jours)';
      durationHint.innerHTML = '<i class="ph ph-info"></i> Actif pour <span id="daysPreview">' + daysInput.value + '</span> jours • 0 = illimité manuel';
      daysInput.value = daysInput.value || '30';
      daysInput.required = false;
      daysInput.min = '0';
      break;
      
    case 'lifetime':
      durationGroup.style.display = 'none';
      daysInput.value = '0';
      daysInput.required = false;
      break;
  }
  
  // Re-trigger pour mettre à jour la preview
  if (daysInput.oninput) daysInput.oninput.call(daysInput);
}

function openAddModal() { 
  document.getElementById('modalAdd').style.display = 'flex';
  setTimeout(() => updateDurationField(), 100);
}

function openEditModal(id, name, bot, status) {
  document.getElementById('editSubtitle').innerText = name + " • " + bot.toUpperCase();
  document.getElementById('formStatus').action = "/admin/subs/set_status/" + id;
  document.getElementById('formLinkStripe').action = "/admin/subs/link_stripe/" + id;
  document.getElementById('modalEdit').style.display = 'flex';
}

function openLocksModal() {
  document.getElementById('modalLocks').style.display = 'flex';
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }

window.onclick = e => { if (e.target.classList.contains('modal-overlay')) e.target.style.display = 'none'; };

function filterTable(filter) {
  if (filter) currentFilter = filter;
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
  if (filter) event.target.classList.add('active');
  
  document.querySelectorAll('#dataTable tbody tr').forEach(row => {
    const status = row.getAttribute('data-status');
    const searchData = row.getAttribute('data-search');
    
    const matchesFilter = (currentFilter === 'all') || 
                         (currentFilter === 'active' && (status === 'active' || status === 'past_due')) || 
                         (currentFilter === 'trial' && (status === 'trial' || status === 'trialing')) || 
                         (currentFilter === 'canceled' && (status === 'canceled' || status === 'unpaid' || status === 'incomplete')) ||
                         (currentFilter === 'lifetime' && status === 'lifetime');
    
    const matchesSearch = !search || searchData.includes(search);
    
    row.style.display = (matchesFilter && matchesSearch) ? '' : 'none';
  });
}

function filterLocks() {
  const search = document.getElementById('searchLocks').value.toLowerCase();
  
  document.querySelectorAll('#locksTableBody tr').forEach(row => {
    const searchData = row.getAttribute('data-search');
    row.style.display = !search || searchData.includes(search) ? '' : 'none';
  });
}

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => filterTable(), 300);
}

function sortTable(column) {
  const table = document.getElementById('dataTable');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  
  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = 'asc';
  }
  
  table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
  event.target.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
  
  rows.sort((a, b) => {
    let valA, valB;
    
    switch(column) {
      case 'bot': valA = a.getAttribute('data-bot'); valB = b.getAttribute('data-bot'); break;
      case 'guild': valA = a.getAttribute('data-guild'); valB = b.getAttribute('data-guild'); break;
      case 'status': valA = a.getAttribute('data-status'); valB = b.getAttribute('data-status'); break;
      case 'days': valA = parseInt(a.getAttribute('data-days')); valB = parseInt(b.getAttribute('data-days')); break;
      case 'expiry': valA = parseFloat(a.getAttribute('data-expiry')); valB = parseFloat(b.getAttribute('data-expiry')); break;
      default: return 0;
    }
    
    return currentSort.direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });
  
  rows.forEach(row => tbody.appendChild(row));
}

function toggleSelectAll() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.row-select').forEach(cb => {
    if (cb.closest('tr').style.display !== 'none') cb.checked = checked;
  });
  updateBulkActions();
}

function updateBulkActions() {
  const selected = document.querySelectorAll('.row-select:checked').length;
  const bulkBar = document.getElementById('bulkBar');
  document.getElementById('selectedCount').textContent = selected;
  
  if (selected > 0) {
    bulkBar.classList.add('show');
    document.querySelectorAll('.row-select:checked').forEach(cb => cb.closest('tr').classList.add('selected'));
  } else {
    bulkBar.classList.remove('show');
  }
  
  document.querySelectorAll('.row-select:not(:checked)').forEach(cb => cb.closest('tr').classList.remove('selected'));
}

function clearSelection() {
  document.querySelectorAll('.row-select').forEach(cb => cb.checked = false);
  document.getElementById('selectAll').checked = false;
  updateBulkActions();
}

function exportSelected() {
  const selected = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.dataset.id);
  Toastify({ text: `Export de ${selected.length} item(s)`, duration: 2000, style: { background: '#6366f1' } }).showToast();
}

function exportCSV() {
  Toastify({ text: '✅ Export CSV en cours...', duration: 2000, style: { background: '#10b981' } }).showToast();
}

function refreshTable() {
  Toastify({ text: '🔄 Actualisation...', duration: 1000, style: { background: '#6366f1' } }).showToast();
  setTimeout(() => location.reload(), 500);
}

function toggleAutoRefresh() {
  isAutoRefresh = !isAutoRefresh;
  const btn = document.getElementById('autoRefreshBtn');
  
  if (isAutoRefresh) {
    btn.classList.add('active');
    autoRefreshInterval = setInterval(() => refreshTable(), 30000);
    Toastify({ text: '🔄 Auto-refresh ON', duration: 2000, style: { background: '#10b981' } }).showToast();
  } else {
    btn.classList.remove('active');
    clearInterval(autoRefreshInterval);
    Toastify({ text: 'Auto-refresh OFF', duration: 2000, style: { background: '#64748b' } }).showToast();
  }
}

function syncStripe(id) {
  if (!confirm('Synchroniser avec Stripe ?')) return;
  
  const btn = event.target.closest('button');
  btn.innerHTML = '<span class="loading-spinner"></span>';
  btn.disabled = true;
  
  fetch(`/admin/subs/sync_stripe/${id}`, { method: 'POST' })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        Toastify({ text: '✅ Synchronisé', duration: 2000, style: { background: '#10b981' } }).showToast();
        setTimeout(() => location.reload(), 1000);
      } else {
        Toastify({ text: '❌ ' + d.error, duration: 4000, style: { background: '#ef4444' } }).showToast();
        btn.innerHTML = '<i class="ph ph-arrows-clockwise"></i>';
        btn.disabled = false;
      }
    });
}

function deleteSub(id) {
  if (!confirm('⚠️ Supprimer définitivement ?')) return;
  
  fetch(`/admin/subs/delete/${id}`, { method: 'POST' })
    .then(() => {
      Toastify({ text: '✅ Supprimé', duration: 2000, style: { background: '#ef4444' } }).showToast();
      setTimeout(() => location.reload(), 800);
    });
}

function releaseLock(id) {
  if (!confirm('Libérer ce lock ?')) return;
  
  fetch(`/admin/locks/release/${id}`, { method: 'POST' })
    .then(() => {
      Toastify({ text: '✅ Lock libéré', duration: 2000, style: { background: '#10b981' } }).showToast();
      setTimeout(() => location.reload(), 800);
    });
}

function clearAllLocks() {
  if (!confirm('⚠️ SUPPRIMER TOUS LES LOCKS ? Action irréversible !')) return;
  
  Toastify({ text: '🚧 Fonction à implémenter côté serveur', duration: 3000, style: { background: '#f59e0b' } }).showToast();
  // TODO: Ajouter endpoint /admin/locks/clear_all
}

document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    openAddModal();
  }
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
  }
});

console.log('✅ Panel Admin 4U BOT V3 initialisé');
</script>

{% endblock %}
